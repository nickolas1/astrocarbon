/*! astrocarbon 02-10-2014 */
$(function(){if(navigator.userAgent.match(/Android/i)){window.scrollTo(0,0);var a=$(document).height(),b=window.outerHeight;b>a&&(b/=window.devicePixelRatio,$("BODY").css("height",b+"px")),window.scrollTo(1,0)}});var altcrement=-1;$(window).resize(function(){var a=parseFloat($("html").css("font-size"));$("html").css("font-size",a+(altcrement*=-1)+"px")});var globalretally,lbexcess,stepheight,mapw,maph,mapscale,uw,letterboxcalc=function(){lbexcess=Math.max(0,($(window).height()-.5625*$(window).width())/2),stepheight=1.15*Math.max(.5625*$(window).width(),$(window).height()-2*lbexcess),mapw=Math.floor(10*$(window).width()/12*.9),maph=Math.floor(.42*mapw),mapscale=105*($(window).width()/900),uw=$(window).width()/12};letterboxcalc();var backgroundScrollController=function(){var a=$(window).scrollTop(),b=0;b=a/stepheight,$("#background0").css("opacity",Math.max(1-4*(b-.4),0)),a>=stepheight&&(b=(a-stepheight+.001)/stepheight,$("#background1").css("opacity",Math.max(1-4*(b-.4),0))),a>=2*stepheight&&(b=(a-2*stepheight+.001)/stepheight,$("#background2").css("opacity",Math.max(1-4*(b-.4),0))),a>=3*stepheight&&(b=(a-3*stepheight+.001)/stepheight,$("#background3").css("opacity",Math.max(1-4*(b-.4),0))),a>=4*stepheight&&(b=(a-4*stepheight+.001)/stepheight,$("#background4").css("opacity",Math.max(1-4*(b-.4),0)))};$(window).scroll(backgroundScrollController);var pulseduration=1700,pulse=function(a,b,c,d,e){"continuebutton invisible"!==a.attr("class")?a.animate(d,b,c,function(){pulse(a,b,c,e,d)}):a.animate({opacity:0},b/2,c)};$(function(){$(".continuebutton").each(function(){pulse($(this),pulseduration,"swing",{opacity:.3},{opacity:.8})})});var mapBaseGrey="rgb(93, 88, 86)",mapHoverOrange="#ffac0d",mapSelectedOrange="#ff8600",mapPulseWhite="#ffdcbd",mapOceanBlue="rgb(250, 250, 255)",textColor="#302407",svgMap=d3.select("#introWorldMap").append("svg").attr("width",mapw).attr("height",maph),worldmap=svgMap.append("g").attr("width",mapw).attr("height",maph),projection=d3.geo.bromley().scale(mapscale).translate([mapw/2,maph/2]),graticule=d3.geo.graticule(),path=d3.geo.path().projection(projection);worldmap.append("path").datum({type:"Sphere"}).attr("class","globe").attr("d",path),worldmap.append("path").datum(graticule).attr("class","graticule").attr("d",path);var maptextw=mapw,maptexth=maph/5.5,svgSelectedRegion=d3.select("#selectedRegionText").append("svg").attr("width",maptextw).attr("height",maptexth),selectionText=svgSelectedRegion.append("g").attr("width",maptextw).attr("height",maptexth).append("text").attr("x",.5*maptextw).attr("y",.6*maptexth).attr("class","regiontitle").attr("id","regiontitle").attr("text-anchor","middle").attr("fill","rgb(240, 241, 245)").attr("font-size","20px").text(""),selectionSubText=svgSelectedRegion.append("g").attr("width",maptextw).attr("height",maptexth).append("text").attr("x",.5*maptextw).attr("y",.95*maptexth).attr("class","regionsubtitle").attr("id","regionsubtitle").attr("text-anchor","middle").attr("fill","rgb(240, 241, 245)").text(""),regionNames=[{id:0,name:"africa"},{id:1,name:"antarctica"},{id:2,name:"asia"},{id:3,name:"europe"},{id:4,name:"hawaii"},{id:5,name:"northernamericas"},{id:6,name:"oceania"},{id:7,name:"southamerica"}],clicked=[!1,!1,!1,!1,!1,!1,!1,!1],regionTitles=["Africa","Antarctica","Asia","Europe","Hawaii","Northern Americas","Oceania","South America"],regionSubTitles=["","(awesome)","(defined as AFC minus Australia)","(defined as UEFA)","","(including Caribbean but not Hawaii)","(defined as OFC plus Australia)",""],confFlight0,confFlight1,confFlight2,confFlight3,confFlight4,confFlight5,confFlight6,confFlight7,confFlight=[0,0,0,0,0,0,0,0],obsFlight=[0,0,0,0,0,0,0,0],compPersonal=0,compHPC=0,populateConferences=function(){var a,b,c,d,e,f=0;for(d=0;d<regionNames.length;d++)if(confFlight[d]=0,1!=d)if(clicked[d])c="within "+regionTitles[d];else{{(function(c){e=String(f),a="#confknob"+e,b="#confknob"+e+"parent",knobtextid="#confregion"+e,$(a).css("visibility","visible"),$(b).css("visibility","visible"),$(knobtextid).html(regionTitles[d]),$(a).knob({scroll:!1,change:function(a){confFlight[c]=a,globalretally=!0}}),$(a).val(0).trigger("change")})(f)}f+=1}for(clicked[1]?f-=1:(e=String(f),a="#confknob"+e,b="#confknob"+e+"parent",knobtextid="#confregion"+e,$(a).css("visibility","visible"),$(b).css("visibility","visible"),$(knobtextid).html(c),$(a).knob({scroll:!1,change:function(a){confFlight[f]=a,globalretally=!0}}),$(a).val(1).trigger("change"),confFlight[f]=1),d=f+1;8>d;d++)a="#confknob"+String(d),b="#confknob"+String(d)+"parent",$(a).val(0).trigger("change"),$(a).css("visibility","hidden"),$(b).css("visibility","hidden")},populateObservations=function(){var a,b,c,d,e,f=0;for(d=0;d<regionNames.length;d++)if(obsFlight[d]=0,clicked[d])c="within "+regionTitles[d];else{{(function(c){e=String(f),a="#obsknob"+e,b="#obsknob"+e+"parent",knobtextid="#obsregion"+e,$(a).css("visibility","visible"),$(b).css("visibility","visible"),$(knobtextid).html(regionTitles[d]),$(a).knob({scroll:!1,change:function(a){obsFlight[c]=a,globalretally=!0}}),$(a).val(0).trigger("change")})(f)}f+=1}for(e=String(f),a="#obsknob"+e,b="#obsknob"+e+"parent",knobtextid="#obsregion"+e,$(a).css("visibility","visible"),$(b).css("visibility","visible"),$(knobtextid).html(c),$(a).knob({scroll:!1,change:function(a){obsFlight[f]=a,globalretally=!0}}),$(a).val(0).trigger("change"),d=f+1;8>d;d++)a="#obsknob"+String(d),b="#obsknob"+String(d)+"parent",$(a).css("visibility","hidden"),$(b).css("visibility","hidden")};$("#compknob0").knob({width:Math.floor(2.5*uw),height:Math.floor(2.5*uw),thickness:.15,min:0,max:24,cursor:15,scroll:!1,change:function(a){compPersonal=365*a,globalretally=!0}}),$("#compknob1").knob({width:Math.floor(2.5*uw),height:Math.floor(2.5*uw),thickness:.15,min:5,max:16,cursor:32,scroll:!1,displayInput:!1,change:function(a){var b="0";if(6>a)compHPC=0;else{var c=Math.pow(10,a/2);compHPC=c.toPrecision(1),b=String(compHPC).charAt(0)+"x10<sup>"+String(compHPC).charAt(3)+"</sup>"}$("#fauxHPCval").html(b),globalretally=!0}});var addFauxHPCval=function(){var a=2.5*parseInt($("#compknob1parent").css("width"))/4,b=1.5*parseInt($("#compknob1parent").css("width"))/8;$("#fauxHPCval").css({position:"absolute",top:$("#compknob1parent").position().top,left:$("#compknob1parent").position().left+b,width:a,height:a,"font-size":$("#compknob0").css("font-size"),"line-height":a+"px","z-index":"-1"})};$(function(){populateConferences(),populateObservations(),setLetterboxes(),addFauxHPCval(),styleKnobs()});var globalclicked=-1;for(i=0;i<regionNames.length;i++)var makeRegion=function(a){d3.json("data/"+regionNames[i].name+".json",function(b,c){var d=worldmap.append("g");4===a?d.selectAll(".countries").data(topojson.feature(c,c.objects.countries).features).enter().append("path").attr("class","region "+regionNames[a].name).style("fill",mapBaseGrey).attr("d",path).attr("transform",function(a){var b=path.centroid(a),c=b[0],d=b[1];return"translate("+c+","+d+")scale(2)translate("+-c+","+-d+")"}):d.selectAll(".countries").data(topojson.feature(c,c.objects.countries).features).enter().append("path").attr("class","region "+regionNames[a].name).style("fill",mapBaseGrey).attr("d",path),d.on("mouseover",function(){clicked[a]||d3.selectAll("."+regionNames[a].name).transition().duration(150).style("fill",mapHoverOrange)}).on("mouseout",function(){clicked[a]||d3.selectAll("."+regionNames[a].name).transition().duration(200).style("fill",mapBaseGrey)}).on("click",function(){d3.selectAll("."+regionNames[a].name).style("fill",mapHoverOrange).transition().duration(60).style("fill",mapPulseWhite).transition().delay(60).duration(180).style("fill",mapSelectedOrange).attr("class",regionNames[a].name+" selected"),d3.select("#regiontitle").text(regionTitles[a]).attr("opacity","0").transition().duration(200).attr("opacity","1"),d3.select("#regionsubtitle").text(regionSubTitles[a]).attr("opacity","0").transition().delay(100).duration(200).attr("opacity","1"),$("#introDone").attr("class","continuebutton"),pulse($("#introDone"),pulseduration,"swing",{opacity:.8},{opacity:.3}),clicked[a]=!0,globalretally=!0,globalclicked>=0&&(clicked[globalclicked]=!clicked[globalclicked],d3.selectAll("."+regionNames[globalclicked].name).attr("class","region "+regionNames[globalclicked].name).transition().duration(200).style("fill",mapBaseGrey)),globalclicked!=a?(globalclicked=regionNames[a].id,populateConferences(),populateObservations(),addFauxHPCval()):(globalclicked=-1,d3.select("#regiontitle").attr("opacity","1").transition().duration(180).attr("opacity","0"),d3.select("#regionsubtitle").attr("opacity","1").transition().duration(180).attr("opacity","0"),$("#introDone").attr("class","continuebutton invisible"))})})}(i);var confFlightMatrix=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],obsFlightMatrix=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],parseFlights=function(){var a,b,c,d=confFlight.slice(0),e=obsFlight.slice(0),f=6,g=7;for(a=0;a<regionNames.length;a++)for(b=a;b<regionNames.length;b++)confFlightMatrix[a][b]=0,obsFlightMatrix[a][b]=0;for(1===globalclicked&&(f=7),console.log(confFlight),console.log(obsFlight),1!==globalclicked&&d.splice(1,0,0),d.splice(globalclicked,0,confFlight[f]),e.splice(globalclicked,0,obsFlight[g]),console.log(d),console.log(e),c=f+1,globalclicked>f&&(c=f),d[g+1]=0,e[g+1]=0,console.log(d),console.log(e),console.log(d),console.log(e),a=0;g>=a;a++){var h=Math.min(Math.max(globalclicked,0),a),i=Math.max(Math.max(globalclicked,0),a);console.log(h,i,a,d[a]),confFlightMatrix[h][i]=d[a],obsFlightMatrix[h][i]=e[a]}},flightCostMatrix=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]];flightCostMatrix[0][0]=.5,flightCostMatrix[0][1]=1.34,flightCostMatrix[0][2]=2.48,flightCostMatrix[0][3]=1.9,flightCostMatrix[0][4]=4.06,flightCostMatrix[0][5]=2.96,flightCostMatrix[0][6]=2.34,flightCostMatrix[0][7]=1.94,flightCostMatrix[1][1]=.1,flightCostMatrix[1][2]=3.06,flightCostMatrix[1][3]=3.18,flightCostMatrix[1][4]=2.76,flightCostMatrix[1][5]=3.12,flightCostMatrix[1][6]=1.44,flightCostMatrix[1][7]=1.34,flightCostMatrix[2][2]=.5,flightCostMatrix[2][3]=1.66,flightCostMatrix[2][4]=1.92,flightCostMatrix[2][5]=2.24,flightCostMatrix[2][6]=1.88,flightCostMatrix[2][7]=4.02,flightCostMatrix[3][3]=.5,flightCostMatrix[3][4]=2.46,flightCostMatrix[3][5]=1.4,flightCostMatrix[3][6]=3.52,flightCostMatrix[3][7]=2.54,flightCostMatrix[4][4]=.1,flightCostMatrix[4][5]=2.16,flightCostMatrix[4][6]=1.92,flightCostMatrix[4][7]=2.34,flightCostMatrix[5][5]=.5,flightCostMatrix[5][6]=3.14,flightCostMatrix[5][7]=1.8,flightCostMatrix[6][6]=.5,flightCostMatrix[6][7]=2.4,flightCostMatrix[7][7]=.5;var confFlightCost,obsFlightCost,compPersonalCost,compHPCCost,costFlights=function(){confFlightCost=0,obsFlightCost=0;var a,b;for(a=0;a<regionNames.length;a++)for(b=a;b<regionNames.length;b++)confFlightCost+=flightCostMatrix[a][b]*confFlightMatrix[a][b],obsFlightCost+=flightCostMatrix[a][b]*obsFlightMatrix[a][b]},costComputers=function(){var a;compPersonalWh=60*compPersonal/1e3,a=1e10*compHPC/75e7/1e3,compPersonalCost=.5*compPersonalWh/1e3,compHPCCost=.5*a/1e3,console.log(compHPCCost,compPersonalCost)},setLetterboxes=function(){$(".letterbox").css("height",lbexcess),$(".backgroundimage").css("top",lbexcess),$("#topspacer").css("height",lbexcess),$("#bottomspacer").css("height",lbexcess),$(".frame").css("height",stepheight),$(".imagecredit").css("bottom",lbexcess+10)},resizeEverything=function(){letterboxcalc(),addFauxHPCval(),setLetterboxes()};$(window).resize(resizeEverything);var styleFlightKnobs=function(){$(".knoby.flight").trigger("configure",{width:Math.floor(1.5*uw),height:Math.floor(1.5*uw),thickness:.15,min:0,max:8,cursor:32})},styleKnobs=function(){$(".knoby").trigger("configure",{angleOffset:18,angleArc:324,fgColor:"rgba(186, 70, 135, 1.0)",bgColor:"rgba(99, 49, 82, 0.5)",inputColor:"#302407",font:"Open Sans",fontWeight:400}),styleFlightKnobs()},margin={top:maph/6,right:0,bottom:maph/15,left:maph/5},width=mapw-margin.left-margin.right,height=1.1*maph-margin.top-margin.bottom;$("#tally").css("height",height);var xscale=d3.scale.linear().range([0,width]),yscale=d3.scale.linear().range([height,0]),line=d3.svg.line().x(function(a){return xscale(a.rank)}).y(function(a){return yscale(a.co2)}),co2plot=d3.select("#usagechart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")").attr("id","co2chartsvg"),bisectRank=d3.bisector(function(a){return a.rank}).left,bisectTons=d3.bisector(function(a){return-a.co2}).left,formatCO2val=d3.format(",.2f"),formatCO2=function(a){return formatCO2val(a)+" tons"},worldCO2Data;d3.csv("data/cdiac-2010-carbon-emission-ranking.csv",function(a){return{rank:+a.rank,name:a.name,co2:3.67*+a.carbon}},function(a,b){worldCO2Data=b;var c=d3.max(b.map(function(a){return a.rank})),d=d3.min(b.map(function(a){return a.rank})),e=(d3.min(b.map(function(a){return a.co2})),d3.max(b.map(function(a){return a.co2})));xscale.domain([c+2,d]),yscale.domain([0,e+2])});var mydata;$("#tally").onScreen({doIn:function(){function a(){var a=xscale.invert(d3.mouse(this)[0]),b=bisectRank(worldCO2Data,a,d3.min(worldCO2Data.map(function(a){return a.rank})),d3.max(worldCO2Data.map(function(a){return a.rank}))),c=worldCO2Data[b-1],d=worldCO2Data[b],e=a-c.rank>d.rank-a?d:c;f.attr("transform","translate("+xscale(e.rank)+","+yscale(e.co2)+")"),f.select("#co2text").text(formatCO2(e.co2)),f.select("#nametext").text(e.name)}if(globalretally){parseFlights(),costFlights(),costComputers(),globalretally=!1,$("#co2chartsvg").empty();var b=compPersonalCost+compHPCCost,c=b+confFlightCost+obsFlightCost;$("#compTallyVal").html(b.toString()),$("#obsTallyVal").html(obsFlightCost.toString()),$("#confTallyVal").html(confFlightCost.toString()),$("#totTallyVal").html(c.toString()),mydata=[{rank:bisectTons(worldCO2Data,-b),co2:b,cl:"compCost",txt:"computing"},{rank:bisectTons(worldCO2Data,-obsFlightCost),co2:obsFlightCost,cl:"obsCost",txt:"observing"},{rank:bisectTons(worldCO2Data,-confFlightCost),co2:confFlightCost,cl:"confCost",txt:"conferences"},{rank:bisectTons(worldCO2Data,-c),co2:c,cl:"totalCost",txt:"total"}];var d=function(a,b){return function(c,d){return a(c[b],d[b])}};mydata.sort(d(d3.ascending,"co2"));for(var e=0;4>e;e++)$("#tallyText"+e.toString()).html(mydata[e].txt),$("#tallyVal"+e.toString()).html(mydata[e].co2.toPrecision(2)),$("#tallyVal"+e.toString()).attr("class",mydata[e].cl);maxrank=d3.max(worldCO2Data.map(function(a){return a.rank})),minrank=Math.min(10,d3.min(mydata.map(function(a){return a.rank}))-2),maxco2=Math.max(20,d3.max(mydata.map(function(a){return a.co2}))+2),5>minrank&&(maxco2=40),minco2=d3.min(worldCO2Data.map(function(a){return a.co2})),xscale.domain([maxrank,minrank]),yscale.domain([0,maxco2]),co2plot.append("path").datum(worldCO2Data).attr("class","co2line").attr("d",line);var f=co2plot.append("g").attr("class","focus").style("display","none");f.append("circle").attr("r",4.5).attr("opacity",.5),f.append("text").attr("id","co2text").attr("x",0).attr("y",-20).attr("font-weight",300).attr("font-size","0.9em").attr("text-anchor","end"),f.append("text").attr("id","nametext").attr("x",0).attr("y",-37).attr("font-size","1.1em").attr("text-anchor","end"),co2plot.selectAll("line.horizontalGrid").data([0,5,10,20,40]).enter().append("line").attr("class","horizontalGrid").attr("x1",0).attr("x2",width).attr("y1",function(a){return yscale(a)}).attr("y2",function(a){return yscale(a)}),co2plot.selectAll(".myvals").data(mydata).enter().append("rect").attr("x",function(a,b){return xscale(maxrank+2+b)}).attr("y",function(a){return yscale(a.co2)}).attr("class","myvals").attr("id",function(a){return a.cl}).attr("width",2).attr("height",function(a){return height-yscale(a.co2)}).transition().delay(function(a,b){return 700+100*b}).attr("x",function(a){return xscale(a.rank)}).duration(function(a,b){return 200+150*b}),co2plot.append("rect").attr("class","overlay").attr("width",width).attr("height",height).on("mouseover",function(){f.style("display",null)}).on("mouseout",function(){f.style("display","none")}).on("mousemove",a),maxco2>23?(co2plot.append("text").attr("x",0).attr("y",yscale(40)).attr("dy",-2).attr("class","co2label").text("40 tons of CO2 / person / year"),co2plot.append("text").attr("x",0).attr("y",yscale(20)).attr("dy",-2).attr("class","co2label").text("20 tons")):co2plot.append("text").attr("x",0).attr("y",yscale(20)).attr("dy",-2).attr("class","co2label").text("20 tons of CO2 / person / year"),co2plot.append("text").attr("x",0).attr("y",yscale(10)).attr("dy",-2).attr("class","co2label").text("10 tons"),co2plot.append("text").attr("x",0).attr("y",yscale(5)).attr("dy",-2).attr("class","co2label").text("5 tons")}},tolerance:Math.floor(.8*$(window).height()-lbexcess)});